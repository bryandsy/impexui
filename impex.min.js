!function(global){"use strict";function ExpProp(e){this.propName=e,this.subProps={},this.expNodes=[],this.attrObserveNodes=[],this.watchs=[]}function ExpNode(e,t,n,r,i,s){this.node=e,this.attrName=t,this.origin=n,this.expMap=r,this.component=i,this.toHTML=s}function AttrObserveNode(e,t){this.directive=e,this.expObj=t}function Watch(e,t,n){this.cbk=e,this.ctrlScope=t,this.segments=n}function Component(e){var t="C_"+im_counter++;this.$__id=t,this.$__state=Component.state.created,this.$view=e,this.$name,this.$parent,this.$__components=[],this.$__expNodes=[],this.$__expPropRoot=new ExpProp,this.$__watcher,this.$__events={},this.$template,this.$templateURL,this.$replace=!0,this.$restrict,this.$isolate,this.onCreate,this.onInit,this.onDisplay,this.onDestroy}function broadcast(e,t,n){for(var r=0;r<e.length;r++){var i=e[r],s=i.$__events[t],a=!0;if(s){a=!1;for(var o=0;o<s.length;o++)a=s[o].apply(i,n)}a&&i.$__components.length>0&&broadcast(i.$__components,t,n)}}function View(e,t,n){this.el=e,this.__nodes=n,this.__evMap={},this.__target=t}function tmplExpFilter(e,t,n){return e=e.replace(REG_TMPL_EXP,function(e,r){var r=r.replace(/\s/gm,"");if("CONTENT"===r)return t;if("BINDPROPS"===r){for(var i="",s=Object.keys(n),a=s.length;a--;)i+=n[s[a]].nodeName+'="'+n[s[a]].nodeValue+'" ';return i}var o=n[r]&&n[r].nodeValue;return o||""})}function Directive(e,t){Component.call(this),this.$value=t,this.$name=e,this.$params,this.$filter,this.$final=!1,this.$endTag=null,this.$priority=0,this.observe}function Filter(e){this.$component=e,this.$value,this.onCreate}function Service(){this.$singleton,this.$host,this.onCreate}function Transition(e,t,n){if(TESTNODE||(TESTNODE=document.createElement("div"),document.body.appendChild(TESTNODE)),n&&n.css===!1)this.$__css=!1;else{TESTNODE.className=e+"-transition",TESTNODE.style.left="-9999px";for(var r=window.getComputedStyle(TESTNODE,null),i=r["transition-duration"].split(","),s=r["transition-delay"].split(","),a=-1,o=i.length;o--;){var l=parseFloat(i[o]),h=parseFloat(s[o]);l+h>a&&(a=l+h)}if(a>0){var c=t.$view,p=t.$__expNodes;p.length<1&&t.$parent&&(p=t.$parent.$__expNodes);for(var o=p.length;o--;){var v=p[o];"class"===v.attrName&&(v.origin+=" "+e+"-transition")}c.addClass(e+"-transition"),this.$__longest=a;var u=null;for(var _ in TRANSITIONS)if(void 0!==c.el.style[_]){u=TRANSITIONS[_];break}c.el.addEventListener(u,this.__done.bind(this),!1),this.$__css=!0}}this.$__comp=t,this.$__view=c,this.$__hook=n||{},this.$__type=e}function Factory(e){this.types={},this.baseClass=e}function _ComponentFactory(e){Factory.call(this,Component),this.viewProvider=e}function _DirectiveFactory(){Factory.call(this,Directive)}function _FilterFactory(){Factory.call(this,Filter)}function _ServiceFactory(){Factory.call(this,Service)}var Util=new function(){function e(){LOGGER.error("can not fetch remote data of : "+this.url)}function t(){LOGGER.error("load timeout : "+this.url)}function n(){(0===this.status||this.status>=200&&this.status<300||304===this.status)&&(i[this.url]||(i[this.url]=this.responseText),this.cbk&&this.cbk(this.responseText))}this.inherits=function(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e},this.ext=function(e,t){for(var n=Object.keys(t),r=n.length;r--;){var i=n[r];e[i]=t[i]}},this.extProp=function(e,t){for(var n=Object.keys(t),r=n.length;r--;){var i=n[r];t[i]instanceof Function||void 0!==t[i]&&(e[i]=t[i])}},this.extMethod=function(e,t){for(var n=Object.keys(t),r=n.length;r--;){var i=n[r];t[i]instanceof Function&&(e[i]=t[i])}},this.isObject=function(e){return"object"==typeof e&&null!==e},this.isArray=function(e){return e instanceof Array},this.isString=function(e){return"string"==typeof e},this.isUndefined=function(e){return void 0===e},this.isFunction=function(e){return e instanceof Function};var r=document.createElement("div");this.isDOMStr=function(e){return r.innerHTML=e,r.children[0]?!0:!1},this.isDOM="object"==typeof HTMLElement?function(e){return e instanceof HTMLElement}:function(e){return e&&"object"==typeof e&&e.nodeType&&"string"==typeof e.nodeName};var i={};this.loadTemplate=function(r,s,a){if(i[r])return void(s&&s(i[r]));var o=new XMLHttpRequest;o.open("get",r,!0),o.timeout=a||5e3,o.ontimeout=t,o.onerror=e,null===o.onload?o.onload=n:o.onreadystatechange=n,o.cbk=s,o.url=r,o.send(null)}},RAF=function(e){return e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.msRequestAnimationFrame||e.mozRequestAnimationFrame||e.oRequestAnimationFrame||function(t){return e.setTimeout(function(){t(Date.now())},16.7)}}(self),fallback=Object.observe?!1:!0,observedObjects=[],observedOldObjects=[],observedArys=[],observedOldArys=[],Object_observe=Object.observe||function(e,t){var n={};for(var r in e){var i=e[r];n[r]=i}observedOldObjects.push(e),observedObjects.push({oldVer:n,newVer:e,handler:t})},Object_unobserve=Object.unobserve||function(e,t){var n=observedOldObjects.indexOf(e);n>-1&&(observedObjects.splice(n,1),observedOldObjects.splice(n,1))},Array_observe=Array.observe||function(e,t){var n=[];if(!(e instanceof Array))throw new Error("Array.observe cannot observe non-array");for(var r=e.length;r--;)n.unshift(e[r]);observedOldArys.push(e),observedArys.push({oldVer:n,newVer:e,handler:t})},Array_unobserve=Array.unobserve||function(e,t){var n=observedOldArys.indexOf(e);n>-1&&(observedArys.splice(n,1),observedOldArys.splice(n,1))};fallback&&function e(){RAF(function(){for(var t=observedObjects.length;t--;){var n=observedObjects[t],r=n.oldVer,i=n.newVer,s=n.handler,a=[];for(var o in r){if(void 0===i[o]){var l={};l.name=o,l.oldValue=r[o],l.object=i,l.type="delete",a.push(l)}if(i[o]!==r[o]){var l={};l.name=o,l.oldValue=r[o],l.object=i,l.type="update",a.push(l)}}for(var o in i)if(void 0===r[o]){var l={};l.name=o,l.oldValue=r[o],l.object=i,l.type="add",a.push(l)}if(a.length>0){s(a),n.oldVer={};for(var o in i){var h=i[o];n.oldVer[o]=h}}}for(var t=observedArys.length;t--;){var n=observedArys[t],r=n.oldVer,i=n.newVer,s=n.handler,l=null;if(r.length===i.length){for(var c=r.length;c--;)if(i[c]!==r[c]){l={},l.type="update";break}}else if(r.length>i.length)l={},l.type="delete";else{var l={};l.type="add"}if(l){l.object=i,l.oldValue=r,s([l]),n.oldVer=[];for(var p=0;p<i.length;p++)n.oldVer.push(i[p])}}e()})}();var lexer=function(){function e(){return{subVars:{},words:[],segments:[],brakLength:0}}function t(e,t,i){if(o.test(e)){var s=r(i,t);return c="var",s}return a.test(e)?(c="str",n(t,RegExp.$1)):(c="",e)}function n(e,t){for(var n=!1,r=t,i=1;i<e.length;i++){var s=e[i];if("\\"!==s){if(!n&&s===t)return r+t;r+=s,n=!1}else n=!0,r+=s}}function r(n,i,s,a){for(var c="",p=[],v=-1,u=-1,_=-1,f=a||e(),d=0;d<i.length;d++){var $=i[d];if(p.length>0)if(o.test($)){var g=e(),m=r(n,i.substr(d),!0,g);d=d+m.length-1;var y=m;o.test(m[0])&&h.indexOf(y)<0&&(f.subVars["."+m]=g,h.indexOf(y)<0&&(y=["."+y])),f.words.push(y)}else if("]"===$||")"===$){if(p.pop(),0===p.length){var b=i.substring(v,d+1);c+=b,f.segments.push(b),_=d}f.words.push($),u=d}else{var w=t($,i.substr(d),n);d=d+w.length-1,f.words.push(w),u=d}else if(l.test($)){if(c+=$,"."===$){var y=c.substr(_+1);y=y.replace(/\./,""),y&&(f.segments.push(y),_=d)}}else{if("["!==$&&"("!==$){if("]"!==$&&")"!==$||!s){var y=c.substr(u+1);y&&("."!==y[0]&&h.indexOf(y)<0&&(y=["."+y]),f.words.push(y));var x=c.substr(_+1);return x&&(f.segments.push(x),_=d),!s&&h.indexOf(y)<0&&(n["."+c]=f),c}var y=c;if(y[y.length-1]!==$){y=y.substring(u+1,y.length),y&&f.words.push(0===i.indexOf(y)?["."+y]:y);var E=y.lastIndexOf(".");E>0&&(y=y.substr(E)),y&&f.segments.push(y),_=d}return u=d,c}p.push($),v=d,f.brakLength++;var C=c.substr(u+1);if(C){var y=C;h.indexOf(C)<0&&0>u&&(y=["."+C]),f.words.push(y)}f.words.push($);var O="["===$?"]":")";if(c[d-1]!==O){var T=C.lastIndexOf(".");T>-1?(C=C.substr(T),f.segments.push(C)):C&&f.segments.push(C),_=d}u=d}}var R=c.substr(c.lastIndexOf("]")+1),P=c.substr(c.lastIndexOf(")")+1);if(R&&P){var F=R.length<P.length?R:P,x=c.substr(_+1);f.segments.push(x);var y="["===F[0]||"("===F[0]?F:"."===F[0]?F:"."+F;f.words.length<1&&h.indexOf(y)<0&&(y=[y]),f.words.push(y)}return s||(n["."+c]=f),c}function i(e){for(var t in e){var n=e[t],r=null,a=null,o=t.lastIndexOf(".");if("]"===t[t.length-1]||")"===t[t.length-1]){o=s(t,n.brakLength);var l="]"===t[t.length-1]?"[":"(",h=n.brakLength;n.watchPathWords=[];for(var c=0;c<n.words.length;c++){var p=n.words[c];if(p===l&&--h<1)break;n.watchPathWords.push(p)}}else n.watchPathWords=n.words.concat(),n.watchPathWords.splice(-1,1);r=t.substr(o),n.lastVar="("===r[0]?t:r,Object.keys(n.subVars).length<1&&(a=t.substring(0,o).replace(/\.$/,""),n.watchPath=a);for(var c=n.segments.length;c--;)n.segments[c]=n.segments[c].replace(/^\.|\.$/g,"");i(n.subVars)}}function s(e,t){for(var n=0;n<e.length;n++){var r=e[n];if(("["===r||"("===r)&&--t<1)return n}}var a=/(['"])/,o=/[a-zA-Z$_]/,l=/[a-zA-Z$_0-9.]/,h=["as","instanceof","typeof","in","true","false"],c="",p={};return function(e){if(p[e])return p[e];for(var n=[],r={},s=0;s<e.length;s++){var a=e[s];c="";var o=t(a,e.substr(s),r);switch(s=s+o.length-1,c){case"var":n.push(h.indexOf(o)<0?["."+o]:o);break;case"str":case"":n.push(o)}}return i(r),p[e]={words:n,varTree:r},p[e]}}(),Scanner=new function(){function e(e){var n=[],r=[];t(e,n);for(var i=n.length;i--;){var e=n[i],s=e.nodeValue,a=[],o=0;s.replace(REG_EXP,function(e,t,n){var r=s.substring(o,n);r&&a.push(r),a.push(e),o=n+e.length});var l=s.substring(o,s.length);if(l&&a.push(l),a.length<2)r.unshift(null);else{for(var h=document.createDocumentFragment(),c=0;c<a.length;c++){var p=document.createTextNode(a[c]);h.appendChild(p)}r.unshift(h)}}for(var c=n.length;c--;){var v=n[c];r[c]&&r[c].childNodes.length>1&&v.parentNode&&v.parentNode.replaceChild(r[c],v)}}function t(e,n){if("SCRIPT"!==e.tagName)if(e.attributes||11===e.nodeType){if(e.childNodes.length>0)for(var r=0,i=e.childNodes.length;i>r;r++)t(e.childNodes[r],n)}else if(3===e.nodeType){if(e.nodeValue.replace(/\t|\r|\s/gim,"").length<1)return;n.push(e)}}function n(e){if(e.$restrict)return e;for(var t=e.$parent;t;){if(t.$name&&t.$restrict)return t;t=t.$parent}return null}function r(e,t){if("SCRIPT"!==e.tagName)if(e.attributes||11===e.nodeType){if(e.tagName){for(var s=e.tagName.toLowerCase(),a=[],o=e.attributes.length;o--;){var l=e.attributes[o];a.push([l.name,l.value])}for(var h=[],o=a.length;o--;){var c=a[o][0];if(0===c.indexOf(CMD_PREFIX)){var p=c.replace(CMD_PREFIX,""),v=p.indexOf(CMD_PARAM_DELIMITER);v>-1&&(p=p.substring(0,v)),DirectiveFactory.hasTypeOf(p)&&(DirectiveFactory.isFinal(p)||DirectiveFactory.hasEndTag(p))&&h.push([p,a[o],DirectiveFactory.priority(p)||0])}}if(h.length>0){h.sort(function(e,t){return t[2]-e[2]});var p=h[0][0],u=h[0][1];if(DirectiveFactory.isFinal(p))return void DirectiveFactory.newInstanceOf(p,e,t,u[0],u[1]);if(DirectiveFactory.hasEndTag(p))return[p,u[1]]}if(ComponentFactory.hasTypeOf(s)){var _=n(t);if(_&&_.$restrict.children){var f=_.$restrict.children.split(",");if(f.indexOf(s)<0)return}var d=ComponentFactory.getRestrictOf(s);if(d&&d.parents){var $=d.parents.split(",");if($.indexOf(_.$name)<0)return}return void t.createSubComponentOf(s,e)}for(var o=a.length;o--;){var g=a[o][0],m=a[o][1];if(REG_CMD.test(g)){var p=g.replace(CMD_PREFIX,""),v=p.indexOf(CMD_PARAM_DELIMITER);v>-1&&(p=p.substring(0,v)),DirectiveFactory.hasTypeOf(p)&&DirectiveFactory.newInstanceOf(p,e,t,g,m)}else":"===g[0]?DirectiveFactory.newInstanceOf("on",e,t,g,m):REG_EXP.test(m)&&i(m,e,t,g)}}if(e.childNodes.length>0){for(var y=null,b=[],o=0,w=e.childNodes.length;w>o;o++)if(y){b.push(e.childNodes[o]);var x=DirectiveFactory.hasEndTag(y[0]),l=e.childNodes[o].getAttribute&&e.childNodes[o].getAttribute(CMD_PREFIX+x);Util.isString(l)&&(DirectiveFactory.newInstanceOf(y[0],b,t,CMD_PREFIX+y[0],y[1]),y=null,b=[])}else y=r(e.childNodes[o],t),y&&b.push(e.childNodes[o]);y&&LOGGER.error("can not find endTag of directive["+CMD_PREFIX+y[0]+"]")}}else if(3===e.nodeType){if(e.nodeValue.replace(/\t|\r|\s/gim,"").length<1)return;i(e.nodeValue,e,t)}}function i(e,t,n,r){var i={},a=!r&&0===e.replace(/\s*/gm,"").indexOf(EXP_START_TAG+EXP2HTML_EXP_TAG);if(a&&(e=e.replace(EXP2HTML_EXP_TAG,"")),e.replace(REG_EXP,function(e,t){var r={},a=1,o=null;FILTER_EXP.test(t)&&(o=s(lexer(RegExp.$1),r,n),a=t.indexOf(FILTER_EXP_START_TAG));var l=t;a>1&&(l=t.substring(0,a));var h=lexer(l);o&&Util.ext(h.varTree,o),i[t]={words:h.words,varTree:h.varTree,filters:r}}),!(Object.keys(i).length<1)){var o=new ExpNode(t,r,e,i,n,a);n.$__expNodes.push(o)}}function s(e,t,n){for(var r=[],i=null,s=!1,a={},o=[],l=e.words,h=0;h<l.length;h++)if(l[h]instanceof Array)for(var c=l[h][0],p=c.split("."),v=1;v<p.length;v++)o.push([p[v]]);else o.push(l[h]);for(var h=0;h<o.length;h++){var c=o[h];switch(c){case":":s=!0,null!==i&&r.push(i),i="";break;case".":s=!1,null!==i&&r.push(i),i="",r=[];break;default:if(c instanceof Array){var u=c[0],_=u.toLowerCase();if(!s&&_&&FilterFactory.hasTypeOf(_))i=null,t[_]=[FilterFactory.newInstanceOf(_,n),r];else{var p=lexer(u);Util.ext(a,p.varTree),r.push(p),i=null}}else{if(!s||!c.replace(/\s+/,""))continue;i+=c.replace(/^['"]|['"]$/g,"")}}}return i&&r.push(i),a}this.scan=function(t,n){for(var i=t.__nodes?t.__nodes:[t.el],s=null,a=[],o=0,l=i.length;l>o;o++)if(e(i[o]),s){a.push(i[o]);var h=DirectiveFactory.hasEndTag(s[0]),c=i[o].getAttribute&&i[o].getAttribute(CMD_PREFIX+h);Util.isString(c)&&(DirectiveFactory.newInstanceOf(s[0],a,n,CMD_PREFIX+s[0],s[1]),s=null,a=[])}else s=r(i[o],n),s&&a.push(i[o]);s&&LOGGER.error("can not find endTag of directive["+CMD_PREFIX+s[0]+"]")},this.parseFilters=s},Builder=new function(){function prelink(e){for(var t=e.$__expNodes.length;t--;){var n=e.$__expNodes[t];for(var r in n.expMap){var i=n.expMap[r],s=i.varTree;for(var a in s){var o=s[a];buildExpModel(e,o,n)}}}for(var t=e.$__components.length;t--;){var l=e.$__components[t];l instanceof Directive||(l.init(),l.display())}for(var t=e.$__components.length;t--;){var l=e.$__components[t];l instanceof Directive&&l.init()}}function buildExpModel(e,t,n){for(var r in t.subVars){var i=t.subVars[r];buildExpModel(e,i,n)}for(var s=walkPropTree(e.$__expPropRoot.subProps,t.segments[0],n),a=1;a<t.segments.length;a++)s=walkPropTree(s.subProps,t.segments[a],n)}function walkPropTree(e,t,n){var r=e[t];return r||(r=e[t]=new ExpProp(t)),n instanceof ExpNode?r.expNodes.indexOf(n)<0&&r.expNodes.push(n):n instanceof AttrObserveNode?r.attrObserveNodes.indexOf(n)<0&&r.attrObserveNodes.push(n):n instanceof Watch&&r.watchs.indexOf(n)<0&&r.watchs.push(n),e[t]}function observerProp(e,t,n){function r(e){n.$__state!==Component.state.suspend&&null!==n.$__state&&changeHandler(e)}var i=Util.isArray(e),s=Util.isObject(e);if(e&&(i||s)){if(e.$__impex__observer){var a=t.join(".");if(e.$__impex__propChains[a]){for(var o=e.$__impex__propChains[a],l=o.length;l--;)if(o[l][1]===n)return;return void o.push([t,n])}return void(e.$__impex__propChains[t.join(".")]=[[t,n]])}if(e.$__impex__observer=r,e.$__impex__propChains={},e.$__impex__propChains[t.join(".")]=[[t,n]],i)e.$__impex__oldVal=e.concat(),Array_observe(e,r);else if(s){if(Util.isDOM(e))return;Object_observe(e,r)}for(var h=Object.keys(e),l=h.length;l--;){var a=h[l];if(0!==a.indexOf("$")){var c=t.concat();c.push(a),observerProp(e[a],c,n)}}}}function changeHandler(e){if(!Util.isString(e))for(var t=e.length;t--;){var n=e[t],r=n.name;if(!r||0!==r.indexOf("$")||"$index"===r){var i=n.object[r],s=n.oldValue;Util.isArray(n.object)&&(i=n.object,s=n.object.$__impex__oldVal);for(var a=n.object.$__impex__propChains,o=Object.keys(a),l=o.length;l--;)for(var h=o[l],c=a[h],p=c.length;p--;){var v=c[p][0],u=c[p][1],_=v.concat();r&&!Util.isArray(n.object)&&_.push(r),__propStr=null,__lastMatch=void 0,recurRender(u,_,n.type,i,s,0,u),u.$__watcher instanceof Function&&u.$__watcher(n.type,i,s,_),observerProp(i,_,u)}if(!Util.isArray(n.object)&&Util.isArray(n.oldValue))Array_unobserve(n.oldValue,n.oldValue.$__impex__observer);else{if(Util.isArray(n.object))return void(n.object.$__impex__oldVal=n.object.concat());if(Util.isObject(n.oldValue)){var f=n.oldValue.$__impex__observer;f&&(Object_unobserve(n.oldValue,f),n.oldValue.$__impex__observer=null,n.oldValue.$__impex__propChains=null)}}}}}function rerender(e,t,n,r,i){for(var s,a=e.$__expPropRoot.subProps,o=!1,l=0;l<t.length;l++){var h=t[l];if(sqbExp.test(Object.keys(a).join(","))){o=!0;break}{if(!a[h])break;s=a[h],a=a[h].subProps}}if(s){var c=[];if(o)for(var p=t.length-l-1,v=Object.keys(s.subProps),l=v.length;l--;){var u=v[l];("["===u[0]||u===h)&&findMatchProps(s.subProps[u],p,c)}else c.push(s);for(var _=[],l=c.length;l--;){Renderer.renderExpNode(c[l].expNodes);for(var f=c[l].attrObserveNodes.length;f--;){var d=c[l].attrObserveNodes[f],$=Renderer.evalExp(d.directive,d.expObj);d.directive.observe($)}for(var f=c[l].watchs.length;f--;){var g=c[l].watchs[f];if(!(g.segments.length<t.length||_.indexOf(g)>-1)){for(var m=!0,u=0;u<g.segments.length&&t[u];u++)if("["!==g.segments[u][0]&&"["!==t[u][0]&&g.segments[u]!==t[u]){m=!1;break}if(m){var y=r,b=i;if(g.segments.length>t.length){for(var w=g.segments.slice(u),x="$var",u=0;u<w.length;u++){var E=w[u];x+="["===E[0]?E:"."+E}try{y=new Function("$var","return "+x)(r),b=new Function("$var","return "+x)(i)}catch(C){LOGGER.debug("error on parse watch params"),y=null}}g.cbk&&g.cbk.call(g.ctrlScope,n,y,b,t),_.push(g)}}}}}}function findMatchProps(e,t,n){if(1>t)return void n.push(e);for(var r in e.subProps)findMatchProps(e.subProps[r],t-1,n)}function recurRender(component,propChain,changeType,newVal,oldVal,depth,topComp){var toRender=!0;if(depth>0){if(!__propStr){__propStr="";for(var k=0;k<propChain.length;k++){var seg=propChain[k];__propStr+="["===seg[0]?seg:"."+seg}}var prop=void 0;try{prop=eval('impex.__components["'+component.$__id+'"]'+__propStr)}catch(e){}Util.isUndefined(prop)?__lastMatch&&__lastMatch!==topComp&&(toRender=!1):(__lastMatch=component,toRender=!1)}if(toRender&&rerender(component,propChain,changeType,newVal,oldVal),component.$isolate)for(var pc0=propChain[0],i=component.$isolate.length;i--;){var k=component.$isolate[i];if(k.indexOf(".")>0){for(var kc=k.split("."),matchAll=!0,kci=0;kci<kc.length;kci++)kc[kci]!==propChain[kci]&&(matchAll=!1);if(matchAll)return}else if(k===pc0)return}for(var j=component.$__components.length;j--;){var subCtrlr=component.$__components[j];recurRender(subCtrlr,propChain,changeType,newVal,oldVal,depth+1,topComp)}}this.buildExpModel=buildExpModel,this.build=function(e){prelink(e),observerProp(e,[],e)};var __propStr=null,__lastMatch=void 0,sqbExp=/(^\[)|(,\[)/},Renderer=new function(){function renderExpNode(e){for(var t={},n=e.length;n--;){var r=e[n],i=null;if(t[r.origin]&&t[r.origin].comp===r.component?i=t[r.origin].val:(i=calcExp(r.component,r.origin,r.expMap),t[r.origin]={comp:r.component,val:i}),r.toHTML){var s=renderHTML(r,i,r.node,r.component);if(s)continue}null!==i&&updateDOM(r.node,r.attrName,i)}}function updateDOM(e,t,n){if(e.setAttribute){e.setAttribute(t,n);var r=propMap[t];r&&r.indexOf(e.tagName)>-1&&(e[t]=n)}else e.parentNode&&(e.nodeValue=n)}function clone(e){if(null===e)return null;var t=e;if(e instanceof Array){t=e.concat();for(var n=t.length;n--;)t[n]=clone(t[n])}else if(Util.isObject(e)){t={};var r=Object.keys(e);if(r.length>0)for(var n=r.length;n--;){{var i=r[n];e[i]}0!==i.indexOf("$__impex__")&&(t[i]="object"==typeof e[i]?clone(e[i]):e[i])}}return t}function calcExp(e,t,n){var r={};for(var i in n){var s=n[i],a=evalExp(e,s),o=s.filters;if(Object.keys(o).length>0){a&&Util.isObject(a)&&(a=clone(a));for(var l in o){for(var h=o[l][0],c=o[l][1],p=[],v=c.length;v--;){var u=c[v];u.varTree&&u.words&&(u=Renderer.evalExp(e,u)),p[v]=u}h.$value=a,a=h.to.apply(h,p)}}r[i]=void 0===a?"":a}for(var l in r)t=t.replace(EXP_START_TAG+l+EXP_END_TAG,r[l]);return t}function evalExp(component,expObj){var evalExp=getExpEvalStr(component,expObj),rs="";try{rs=eval(evalExp)}catch(e){LOGGER.debug(e.message+' when eval "'+evalExp+'"')}return rs}function getExpEvalStr(e,t){var n=t.varTree,r={};for(var i in n){var s=n[i],a=buildVarPath(e,s,i);r[i]=a}var o=joinExpStr(t.words,r);return o}function joinExpStr(e,t){for(var n="",r=0;r<e.length;r++){var i=e[r];n+=i instanceof Array?t[i[0]]:i}return n}function keyWordsMapping(e,t){return"this"===e?t.__getPath():void 0}function buildVarPath(e,t,n){var r={};for(var i in t.subVars){var s=t.subVars[i],a=buildVarPath(e,s,i);r[i]=a}for(var o=!1,l="",h=0;h<t.words.length;h++){var c=t.words[h];if(c instanceof Array){var p=keyWordsMapping(t.segments[0],e);if(p){o=!0;var v=new RegExp("^\\."+t.segments[0]);l+=c[0].replace(v,p)}else l+=r[c[0]]||c[0]}else l+=c}var u="";if(t.watchPath)u=t.watchPath;else for(var h=0;h<t.watchPathWords.length;h++){var c=t.watchPathWords[h];u+=c instanceof Array?r[c[0]]||c[0]:c}return e=u?varInCtrlScope(e,u):varInCtrlScope(e,l),o?l:(e?e.__getPath():"self")+l}function varInCtrlScope(e,t){for(var n=e;n;){if(void 0!==getVarByPath(t,n.__getPath()))return n;n=n.$parent}}function getVarByPath(path,mPath){var varExp=mPath+path,rs=void 0;try{rs=eval(varExp.replace(/^\./,""))}catch(e){}return rs}function renderHTML(e,t,n,r){if(e.__lastVal!==t&&3==n.nodeType){var i=new View(null,null,[n]);if(Util.isUndefined(e.__lastVal)){var s=ViewManager.createPlaceholder("-- [html] placeholder --");ViewManager.insertBefore(s,i),e.__lastVal=t,e.__placeholder=s}e.__lastComp&&(e.__lastComp.destroy(),i=ViewManager.createPlaceholder(""),ViewManager.insertAfter(i,e.__placeholder)),Util.isDOMStr(t)||(t=t.replace(/</gm,"&lt;").replace(/>/gm,"&gt;"));var a=r.createSubComponent(t,i);return a.init(),a.display(),e.__lastComp=a,e.__lastVal=t,!0}}this.render=function(e){renderExpNode(e.$__expNodes);for(var t=e.$__components.length;t--;)Renderer.render(e.$__components[t])},this.renderExpNode=renderExpNode;var propMap={value:["INPUT"]};this.evalExp=evalExp,this.getExpEvalStr=getExpEvalStr};Component.state={created:"created",inited:"inited",displayed:"displayed",suspend:"suspend"},Util.ext(Component.prototype,{data:function(path,val){var expObj=lexer(path),evalStr=Renderer.getExpEvalStr(this,expObj);if(arguments.length>1){Util.isObject(val)||Util.isArray(val)?val=JSON.stringify(val):Util.isString(val)&&(val='"'+val.replace(/\r\n|\n/gm,"\\n").replace(/"/gm,'\\"')+'"');try{eval(evalStr+"= "+val)}catch(e){LOGGER.debug(e.message+"eval error on data("+evalStr+"= "+val+")")}return this}try{return eval(evalStr)}catch(e){LOGGER.debug(e.message+"eval error on data("+evalStr+")")}},closest:function(e){var t=lexer(e),n=Renderer.getExpEvalStr(this,t);return n.replace(/^impex\.__components\["(C_[0-9]+)"\]/,""),impex.__components[RegExp.$1]},on:function(e,t){var n=this.$__events[e];n||(n=this.$__events[e]=[]),n.push(t)},emit:function(){for(var e=arguments[0],t=[this],n=1;n<arguments.length;n++)t.push(arguments[n]);var r=this.$parent;setTimeout(function(){for(;r;){var n=r.$__events[e];if(n){for(var i=!0,s=0;s<n.length;s++)i=!n[s].apply(r,t);if(i)return}r=r.$parent}},0)},broadcast:function(){for(var e=arguments[0],t=[this],n=1;n<arguments.length;n++)t.push(arguments[n]);var r=this;setTimeout(function(){broadcast(r.$__components,e,t)},0)},find:function(e,t,n){e=e.toLowerCase();for(var r=[],i=this.$__components.length;i--;){var s=this.$__components[i];if("*"===e||s.$name===e){var a=!0;if(t)for(var o in t)if(s[o]!==t[o]){a=!1;break}a&&r.push(s)}if(n&&s.$__components.length>0){var l=s.find(e,t,!0);r&&(r=r.concat(l))}}return r},watch:function(e,t){if("*"===e)this.$__watcher=t;else{var n=lexer(e),r=Object.keys(n.varTree);if(r.length<1)return;if(r.length>1)return void LOGGER.warn("error on parsing watch expression["+e+"], only one property can be watched at the same time");var i=n.varTree[r[0]],s=new Watch(t,this,i.segments);Builder.buildExpModel(this,i,s)}return this},add:function(e){this.$__components.push(e),e.$parent=this},createSubComponentOf:function(e,t){var n=ComponentFactory.newInstanceOf(e,t.__nodes?t.__nodes[0]:t);return this.$__components.push(n),n.$parent=this,n},createSubComponent:function(e,t){var n=ComponentFactory.newInstance(e,t&&t.__nodes[0]);return this.$__components.push(n),n.$parent=this,n},init:function(){if(this.$__state===Component.state.created){if(impex.__components[this.$__id]=this,this.$templateURL){var e=this;Util.loadTemplate(this.$templateURL,function(t){var n=e.$view.__init(t,e);n!==!1&&(e.__init(t),e.display())})}else{if(this.$template){var t=this.$view.__init(this.$template,this);if(t===!1)return}this.__init(this.$template)}return this}},__init:function(e){Scanner.scan(this.$view,this),LOGGER.log(this,"inited");var t=null;return this.onInit&&(t=this.onInit(e)),t===!1?void this.destroy():void(this.$__state=Component.state.inited)},display:function(){(this.$__state===Component.state.inited||this.$__state===Component.state.suspend)&&(this.$view.__display(this),this.$__state!==Component.state.suspend&&(Renderer.render(this),Builder.build(this)),this.$__state=Component.state.displayed,LOGGER.log(this,"displayed"),this.onDisplay&&this.onDisplay())},destroy:function(){if(null!==this.$__state){if(LOGGER.log(this,"destroy"),this.$parent){var e=this.$parent.$__components.indexOf(this);e>-1&&this.$parent.$__components.splice(e,1),this.$parent=null}for(this.$view.__destroy(this);this.$__components.length>0;)this.$__components[0].destroy();if(this.$view=this.$__components=this.$__expNodes=this.$__expPropRoot=null,this.onDestroy&&this.onDestroy(),!CACHEABLE||!this.$name||this instanceof Directive)impex.__components[this.$__id]=null,delete impex.__components[this.$__id],this.$__impex__observer=this.$__impex__propChains=this.$__state=this.$__id=this.$templateURL=this.$template=this.$restrict=this.$isolate=this.onCreate=this.onInit=this.onDisplay=this.onSuspend=this.onDestroy=null;else{var t=im_compCache[this.$name];t||(t=im_compCache[this.$name]=[]),this.$__state=Component.state.created,this.$__components=[],this.$__expNodes=[],this.$__expPropRoot=new ExpProp,t.push(this)}}},suspend:function(e){(this instanceof Directive||this.$__state===Component.state.displayed)&&(LOGGER.log(this,"suspend"),this.$view.__suspend(this,e===!1?!1:!0),this.onSuspend&&this.onSuspend(),this.$__state=Component.state.suspend)},__getPath:function(){return'impex.__components["'+this.$__id+'"]'}}),View.prototype={__init:function(e,t){var n=this.__target.attributes,r=this.__target.innerHTML,i=tmplExpFilter(e,r,n);t.onBeforeCompile&&(i=t.onBeforeCompile(i));var s=DOMViewProvider.compile(i);if(!s||s.length<1)return LOGGER.error('invalid template "'+e+'" of component['+t.$name+"]"),!1;if(this.__nodes=s,this.el=t.$replace?1===s.length&&1===s[0].nodeType?s[0]:null:this.__target,s.length>1&&LOGGER.warn("more than 1 root node of component["+t.$name+"]"),n)for(var a=n.length;a--;){var o=n[a].name.toLowerCase();o.indexOf("-")>-1&&(o=o.replace(/-[a-z0-9]/g,function(e){return e[1].toUpperCase()}));var l=n[a].value;t[o]=l}this.__comp=t},__display:function(e){if(this.__target&&this.__target.parentNode){var t=null;if(this.__nodes.length>1){t=document.createDocumentFragment();for(var n=0;n<this.__nodes.length;n++)t.appendChild(this.__nodes[n])}else t=this.__nodes[0];e.$replace?this.__target.parentNode.replaceChild(t,this.__target):(this.__target.innerHTML="",this.__target.appendChild(t)),t=null,this.__target=null}},__destroy:function(e){for(var t in this.__evMap)for(var n=this.__evMap[t],r=n.length;r--;)for(var i=n[r],s=i[1],a=this.__nodes.length;a--;)1===this.__nodes[a].nodeType&&this.__nodes[a].removeEventListener(t,s,!1);var o=this.__nodes[0].parentNode;if(o){this.__nodes[0].__impex__view&&(this.__nodes[0].__impex__view=null);for(var r=this.__nodes.length;r--;)this.__nodes[r].parentNode&&o.removeChild(this.__nodes[r])}this.__target&&(this.__target.parentNode.removeChild(this.__target),this.__target=null)},__suspend:function(e,t){var n=this.__nodes[0].parentNode;if(n){t&&(this.__target=document.createComment("-- view suspended of ["+(e.$name||"anonymous")+"] --"),n.insertBefore(this.__target,this.__nodes[0]));for(var r=this.__nodes.length;r--;)this.__nodes[r].parentNode&&n.removeChild(this.__nodes[r])}},on:function(e,t,n){if(this.el){var r=t,i=this.__comp,s="",a=null,o=function(t){var o=r;if(n instanceof Function&&(o=n.call(i,t,r)),o){if(s!=o){var l=lexer(o),h=Renderer.getExpEvalStr(i,l),c=h.replace("self.$event","$event");a=new Function("$event",c),s=o}try{a(t)}catch(p){LOGGER.debug(p.message+" on event "+e+"("+c+")")}}};this.el.addEventListener(e,o,!1),this.__evMap[e]||(this.__evMap[e]=[]),this.__evMap[e].push([t,o])}},off:function(e,t){if(this.el)for(var n=this.__evMap[e],r=n.length;r--;){var i=n[r],s=i[0],a=i[1];s==t&&this.el.removeEventListener(e,a,!1)}},clone:function(){for(var e=[],t=this.__nodes.length;t--;){var n=this.__nodes[t].cloneNode(!0);e.unshift(n)}var r=new View(1===e.length&&1===e[0].nodeType?e[0]:null,null,e);return r},show:function(){return this.el.style.display="",this},hide:function(){return this.el.style.display="none",this},style:function(e,t){return arguments.length>1?(this.el.style[e]=t,this):this.el.style[e]},attr:function(e,t){return arguments.length>1?(this.el.setAttribute(e,t),this):this.el.getAttribute(e)},removeAttr:function(e){return this.el.removeAttribute(e),this},hasClass:function(e){return this.el.className.indexOf(e)>-1},addClass:function(e){e=e.replace(/\s+/gm," ").replace(/^\s*|\s*$/gm,""),e=e.split(" ");for(var t=this.el.className.split(" "),n="",r=e.length;r--;)t.indexOf(e[r])<0&&(n+=e[r]+" ");return this.el.className+=" "+n,this},removeClass:function(e){e=e.replace(/\s+/gm," ").replace(/^\s*|\s*$/gm,"");var t=e.split(" "),n=this.el.className;if(n){for(var r=t.length;r--;){var i=t[r],s=new RegExp("^"+i+"\\s+|\\s+"+i+"$|\\s+"+i+"\\s+","img");n=n.replace(s,"")}this.el.className=n}return this},toggleClass:function(e){e=e.replace(/\s+/gm," ").replace(/^\s*|\s*$/gm,"");for(var t=e.split(" "),n=!1,r=this.el.className,i=t.length;i--;){var s=t[i];if(r.indexOf(s)<0){n=!0;break}}n?this.addClass(e):this.removeClass(e)}};var DOMViewProvider=new function(){var e=document.createElement("div");this.newInstance=function(t,n){if(""===t)return new View(null,n,[document.createTextNode("")]);if(e.innerHTML=t,!e.childNodes[0])return null;for(var r=[];e.childNodes.length>0;){var i=e.removeChild(e.childNodes[0]);r.push(i)}var s=new View(null,n,r);return s},this.compile=function(t){e.innerHTML=t;for(var n=[];e.childNodes.length>0;){{var r=e.removeChild(e.childNodes[0]);r.nodeName.toLowerCase()}if(3===r.nodeType){var i=r.nodeValue.replace(/\s/gm,"");if(""===i)continue}n.push(r)}return n}},ViewManager=new function(){this.$singleton=!0,this.replace=function(e,t){var n=t.__nodes[0],r=e.__nodes[0],i=t.__nodes[0].parentNode,s=r;if(e.__nodes.length>1){s=document.createDocumentFragment();for(var a=0;a<e.__nodes.length;a++)s.appendChild(e.__nodes[a])}if(t.__nodes.length>1){i.insertBefore(s,n);for(var a=t.__nodes.length;a--;)i.removeChild(t.__nodes[a])}else i.replaceChild(s,n)},this.insertBefore=function(e,t){var n=t.__nodes[0],r=e.__nodes[0],i=t.__nodes[0].parentNode,s=r;if(e.__nodes.length>1){s=document.createDocumentFragment();for(var a=0;a<e.__nodes.length;a++)s.appendChild(e.__nodes[a])}i&&i.insertBefore(s,n)},this.insertAfter=function(e,t){var n=t.__nodes[0],r=e.__nodes[0],i=t.__nodes[0].parentNode,s=i.lastChild,a=r;if(e.__nodes.length>1){a=document.createDocumentFragment();for(var o=0;o<e.__nodes.length;o++)a.appendChild(e.__nodes[o])}if(s==n)i.appendChild(a);else{var l=t.__nodes[t.__nodes.length-1].nextSibling;i.insertBefore(a,l)}},this.append=function(e,t){var n=e.__nodes[0],r=t.__nodes[0],i=n;if(e.__nodes.length>1){i=document.createDocumentFragment();for(var s=0;s<e.__nodes.length;s++)i.appendChild(e.__nodes[s])}r.appendChild(i)},this.prepend=function(e,t){var n=e.__nodes[0],r=t.__nodes[0],i=n;if(e.__nodes.length>1){i=document.createDocumentFragment();for(var s=0;s<e.__nodes.length;s++)i.appendChild(e.__nodes[s])}r.insertBefore(i,r.firstChild)},this.createPlaceholder=function(e){return new View(null,null,[document.createComment(e)])}};Util.inherits(Directive,Component),Util.ext(Directive.prototype,{init:function(){impex.__components[this.$__id]=this;var e={},t=this;

this.$value.replace(REG_EXP,function(n,r){var i=lexer(r),s=Renderer.evalExp(t.$parent,i);e[r]={val:s}});var n=this.$value;for(var r in e)n=n.replace(EXP_START_TAG+r+EXP_END_TAG,e[r].val);if(this.$value=n,LOGGER.log(this,"inited"),this.onInit&&this.onInit(),this.$__state=Component.state.inited,this.observe){var i=lexer(n);for(var s in i.varTree){var a=i.varTree[s],o=new AttrObserveNode(this,i);this.$parent&&Builder.buildExpModel(this.$parent,a,o)}var l=Renderer.evalExp(this.$parent,i);this.observe(l)}}}),Filter.prototype={to:function(){return null}};var TRANSITIONS={transition:"transitionend",OTransition:"oTransitionEnd",MozTransition:"mozTransitionend",WebkitTransition:"webkitTransitionEnd"},TESTNODE;Transition.prototype={enter:function(){this.$__start="enter",this.$__css&&this.$__view.addClass(this.$__type+"-enter"),this.$__comp.enter&&this.$__comp.enter(),this.$__hook.enter&&this.$__hook.enter.call(this.$__comp,this.__enterDone.bind(this)),this.$__css&&(this.$__view.el.offsetHeight,this.$__view.removeClass(this.$__type+"-enter"))},__enterDone:function(){},leave:function(){this.$__start="leave",this.$__css&&this.$__view.addClass(this.$__type+"-leave"),this.$__hook.leave&&(this.__leaveDone.$__trans=this,this.$__hook.leave.call(this.$__comp,this.__leaveDone.bind(this)))},__leaveDone:function(){this.$__comp.leave&&this.$__comp.leave()},__done:function(e){if(!(e.elapsedTime<this.$__longest)&&this.$__start){switch(this.$__start){case"enter":this.__enterDone();break;case"leave":this.__leaveDone()}this.$__start="",this.$__view.removeClass(this.$__type+"-leave")}}},Factory.prototype={register:function(e,t,n){if(e=e.toLowerCase(),this.baseClass===Component||this.baseClass===Directive)for(var r=Object.keys(t),i=BUILD_IN_PROPS.length;i--;)if(r.indexOf(BUILD_IN_PROPS[i])>-1)return void LOGGER.error("attempt to overwrite build-in property["+BUILD_IN_PROPS[i]+"] of Component["+e+"]");var s=new Function("clazz","var args=[];for(var i=1;i<arguments.length;i++)args.push(arguments[i]);clazz.apply(this,args)"),a={};Util.extProp(a,t),Util.inherits(s,this.baseClass),Util.extMethod(s.prototype,t),this.types[e]={clazz:s,props:a,services:n}},hasTypeOf:function(e){return e in this.types}},Util.inherits(_ComponentFactory,Factory),Util.ext(_ComponentFactory.prototype,{getRestrictOf:function(e){return this.types[e].props.$restrict},newInstance:function(e){var t=null;if(2===arguments.length){var n=arguments[0],r=arguments[1];t=n,Util.isString(n)?t=this.viewProvider.newInstance(n,r):t.__target=r}else t=e,Util.isDOM(e)&&(t=new View(e,null,[e]));var i=new this.baseClass(t),s=arguments[2];if(s){for(var a=Object.keys(s),o=BUILD_IN_PROPS.length;o--;)if(a.indexOf(BUILD_IN_PROPS[o])>-1)return void LOGGER.error("attempt to overwrite build-in property["+BUILD_IN_PROPS[o]+"] of Component");Util.ext(i,s)}return i},newInstanceOf:function(e,t){if(!this.types[e])return null;var n=null,r=im_compCache[e];if(CACHEABLE&&r&&r.length>0?n=r.pop():(n=new this.types[e].clazz(this.baseClass),Util.extProp(n,this.types[e].props),n.$name=e),n.$view=new View(null,t),n.onCreate){var i=null;if(this.types[e].services){i=[];for(var s=0;s<this.types[e].services.length;s++){var a=ServiceFactory.newInstanceOf(this.types[e].services[s],n);i.push(a)}}i?n.onCreate.apply(n,i):n.onCreate()}return n}});var ComponentFactory=new _ComponentFactory(DOMViewProvider);Util.inherits(_DirectiveFactory,Factory),Util.ext(_DirectiveFactory.prototype,{isFinal:function(e){return!!this.types[e].props.$final},hasEndTag:function(e){return this.types[e].props.$endTag},priority:function(e){return this.types[e].props.$priority},newInstanceOf:function(e,t,n,r,i){if(!this.types[e])return null;var s=null,a=null,o=r.indexOf(CMD_PARAM_DELIMITER);if(o>-1){s=r.substr(o+1);var l=s.indexOf(CMD_FILTER_DELIMITER);l>-1&&(a=s.substr(l+1),s=s.substring(0,l)),s=s.split(CMD_PARAM_DELIMITER)}var h=new this.types[e].clazz(this.baseClass,r,i,n);if(Util.extProp(h,this.types[e].props),t.__impex__view)h.$view=t.__impex__view;else{var c=t,p=[t];Util.isArray(t)&&(p=t,c=t.length>1?null:t[0]),h.$view=new View(c,null,p),t.__impex__view=h.$view}if(s&&(h.$params=s),a&&(h.$filter=a),h.$view.__comp=h,n.add(h),h.$view&&(h.$view.__nodes[0].removeAttribute(h.$name),h.$endTag)){var v=h.$view.__nodes[h.$view.__nodes.length-1];v.removeAttribute(CMD_PREFIX+h.$endTag)}if(h.onCreate){var u=null;if(this.types[e].services){u=[];for(var o=0;o<this.types[e].services.length;o++){var _=ServiceFactory.newInstanceOf(this.types[e].services[o],h);u.push(_)}}u?h.onCreate.apply(h,u):h.onCreate()}return h}});var DirectiveFactory=new _DirectiveFactory;Util.inherits(_FilterFactory,Factory),Util.ext(_FilterFactory.prototype,{newInstanceOf:function(e,t){if(!this.types[e])return null;var n=new this.types[e].clazz(this.baseClass,t);if(Util.extProp(n,this.types[e].props),n.onCreate){var r=null;if(this.types[e].services){r=[];for(var i=0;i<this.types[e].services.length;i++){var s=ServiceFactory.newInstanceOf(this.types[e].services[i],n);r.push(s)}}r?n.onCreate.apply(n,r):n.onCreate()}return n}});var FilterFactory=new _FilterFactory;Util.inherits(_ServiceFactory,Factory),Util.ext(_ServiceFactory.prototype,{newInstanceOf:function(e,t){if(e=e.toLowerCase(),!this.types[e])return null;var n=null;if(this.types[e].props.$singleton?(this.types[e].singleton||(this.types[e].singleton=new this.types[e].clazz(this.baseClass)),n=this.types[e].singleton):(n=new this.types[e].clazz(this.baseClass),Util.extProp(n,this.types[e].props)),n.$host=t,n.onCreate){var r=null;if(this.types[e].services){r=[];for(var i=0;i<this.types[e].services.length;i++){var s=ServiceFactory.newInstanceOf(this.types[e].services[i],n);r.push(s)}}r?n.onCreate.apply(n,r):n.onCreate()}return n}});var ServiceFactory=new _ServiceFactory,TransitionFactory={hooks:{},register:function(e,t){this.hooks[e]=t},transitions:{},get:function(e,t){var n=new Transition(e,t,this.hooks[e]);return n}},CMD_PREFIX="x-",CMD_PARAM_DELIMITER=":",CMD_FILTER_DELIMITER=".",EXP_START_TAG="{{",EXP_END_TAG="}}",REG_EXP=/\{\{#?(.*?)\}\}/gim,REG_TMPL_EXP=/\{\{=(.*?)\}\}/gim,REG_CMD=/x-.*/,EXP2HTML_EXP_TAG="#",EXP2HTML_START_EXP=/^\s*#/,FILTER_EXP=/=>\s*(.+?)$/,FILTER_EXP_START_TAG="=>",LOGGER={log:function(){},debug:function(){},error:function(){},warn:function(){}},CACHEABLE=!1,im_compCache={},im_counter=0,BUILD_IN_PROPS=["emit","broadcast","data","closest","add","on","off","find","watch","init","display","destroy","suspend"],impex=new function(){function e(e){var n=e;do{if(t.indexOf(n)>-1)return!0;n=n.parentNode}while(n);return!1}this.version={v:[0,10,0],state:"",toString:function(){return impex.version.v.join(".")+" "+impex.version.state}},this.website="http://impexjs.org",this.config=function(e){var t=e.delimiters||[];EXP_START_TAG=t[0]||"{{",EXP_END_TAG=t[1]||"}}",REG_EXP=new RegExp(EXP_START_TAG+"(.*?)"+EXP_END_TAG,"img"),REG_TMPL_EXP=new RegExp(EXP_START_TAG+"=(.*?)"+EXP_END_TAG,"img"),LOGGER=e.logger||new function(){this.log=function(){},this.debug=function(){},this.error=function(){},this.warn=function(){}},CACHEABLE=e.cacheable||!1},this.component=function(e,t,n){return t.$template||t.$templateURL?(ComponentFactory.register(e,t,n),this):void LOGGER.error("can not find property '$template' or '$templateURL' of component '"+e+"'")},this.directive=function(e,t,n){return DirectiveFactory.register(e,t,n),this},this.service=function(e,t,n){return ServiceFactory.register(e,t,n),this},this.filter=function(e,t,n){return FilterFactory.register(e,t,n),this},this.transition=function(e,t){return TransitionFactory.register(e,t),this},this.render=function(n,r,i){if(!n)return void LOGGER.error("invalid element, can not render");var s=n.tagName.toLowerCase();if(e(n))return void LOGGER.warn("element ["+s+"] has been rendered");var a=ComponentFactory.newInstanceOf(s,n);if(a||(t.push(n),a=ComponentFactory.newInstance(n,null,r)),a.onCreate){var o=null;if(Util.isArray(i)){o=[];for(var l=0;l<i.length;l++){var h=ServiceFactory.newInstanceOf(i[l],a);o.push(h)}}o?a.onCreate.apply(a,o):a.onCreate()}return a.init(),a.display(),a};var t=[];this.__components={}};impex.service("ViewManager",ViewManager),impex.service("ComponentManager",{hasTypeOf:function(e){return ComponentFactory.hasTypeOf(e)}}),impex.service("Transitions",new function(){this.get=function(e,t){return e=e||"x",TransitionFactory.get(e,t)}}),!function(e){function t(e,n,r){for(var i=e.$__expNodes.length;i--;){var s=e.$__expNodes[i];s.node==n&&"class"===s.attrName&&(s.origin=r)}for(var a=e.$__components.length;a--;)t(e.$__components[a],n,r)}function n(){function e(e,t,n){for(var r=[],i=e;t>=i;i+=n)r.push(i);return r}function t(e){for(var n=0;n<e.$__components.length;n++){var r=e.$__components[n];r.onDisplay&&r.onDisplay(),r.$__components.length>0&&t(r)}}function n(e,t){if(null===e)return null;var r=e;if(e instanceof Array){r=e.concat();for(var i=r.length;i--;)r[i]=n(r[i],t)}else if(Util.isObject(e)){r={};var s=Object.keys(e);if(s.length>0)for(var a=t===!1?!1:!e.$__impex__origin,i=s.length;i--;){{var o=s[i];e[o]}0!==o.indexOf("$__impex__")&&(r[o]="object"==typeof e[o]?n(e[o],a):e[o])}t===!1||r.$__impex__origin||(r.$__impex__origin=e)}return r}this.onCreate=function(e,t){this.$eachExp=/^(.+?)\s+as\s+((?:[a-zA-Z0-9_$]+?\s*,)?\s*[a-zA-Z0-9_$]+?)\s*(?:=>\s*(.+?))?$/,this.$forExp=/^\s*(\d+|[a-zA-Z_$].+?)\s+to\s+(\d+|[a-zA-Z_$].+?)\s*$/,this.$viewManager=e,this.$expInfo=this.parseExp(this.$value),this.$parentComp=this.$parent,this.$__view=this.$view,this.$cache=[],this.$cacheable=this.$view.el?"false"===this.$view.attr("cache")?!1:!0:"false"===this.$view.__nodes[0].getAttribute("cache")?!1:!0,this.$subComponents=[],this.$cacheSize=20,this.$step=this.$view.el?this.$view.attr("step"):this.$view.__nodes[0].getAttribute("step");var n=this.$view.el?this.$view.attr("transition"):this.$view.__nodes[0].getAttribute("transition");null!==n&&(this.$trans=n,this.$ts=t)},this.onInit=function(){if(this.$__state!==Component.state.inited){var t=this;if(this.$forExp.test(this.$expInfo.ds)){var n=RegExp.$1,r=RegExp.$2,i=parseFloat(this.$step);if(0>i)return void LOGGER.error("step <=0 : "+i);i=i||1,isNaN(n)&&(this.$parent.watch(n,function(n,s,a){var o=e(s,r,i),l=o.length-t.$lastDS.length;t.$lastDS=o,t.rebuild(o,l,t.$expInfo.k,t.$expInfo.v)}),n=this.$parent.data(n)),isNaN(r)&&(this.$parent.watch(r,function(r,s,a){var o=e(n,s,i),l=o.length-t.$lastDS.length;t.$lastDS=o,t.rebuild(o,l,t.$expInfo.k,t.$expInfo.v)}),r=this.$parent.data(r)),n=parseFloat(n),r=parseFloat(r),this.$ds=e(n,r,i)}else this.$ds=this.$parent.data(this.$expInfo.ds),this.$parentComp.watch(this.$expInfo.ds,function(e,n,r){if(!t.$ds)return t.$ds=t.$parentComp.data(t.$expInfo.ds),t.$lastDS=t.$ds,void t.build(t.$ds,t.$expInfo.k,t.$expInfo.v);t.$lastDS=n;var i=0,s=0;for(var a in n)n.hasOwnProperty(a)&&0!==a.indexOf("$")&&i++;if(0===i)s=t.$subComponents.length;else for(var a in r)r.hasOwnProperty(a)&&0!==a.indexOf("$")&&s++;t.rebuild(n,i-s,t.$expInfo.k,t.$expInfo.v)});this.$lastDS=this.$ds,this.$placeholder=this.$viewManager.createPlaceholder("-- directive [each] placeholder --"),this.$viewManager.insertBefore(this.$placeholder,this.$view),this.$ds&&this.build(this.$ds,this.$expInfo.k,this.$expInfo.v),this.destroy()}},this.rebuild=function(e,n,r,i){if(e=this.doFilter(e),-999===n&&(n=e.length-this.$subComponents.length),0>n){var s=this.$subComponents.splice(0,-1*n);if(this.$cache.length<this.$cacheSize){for(var a=s.length;a--;)this.$cache.push(s[a]);for(var a=this.$cache.length;a--;)this.$trans&&!this.$cache[a].$__leaving&&"displayed"===this.$cache[a].$__state?(this.$cache[a].$__leaving=!0,this.$cache[a].$transition.leave()):this.$cache[a].suspend(!1)}else for(var a=s.length;a--;)s[a].destroy()}else if(n>0){var o=n;if(this.$cacheable){for(var s=this.$cache.splice(0,n),a=0;a<s.length;a++)this.$subComponents.push(s[a]),this.$viewManager.insertBefore(s[a].$view,this.$placeholder);var o=n-s.length}for(;o--;)this.createSubComp()}var l=Util.isArray(e)?!0:!1,h=0;for(var c in e)if(e.hasOwnProperty(c)&&!(l&&isNaN(c)||0===c.indexOf("$__"))){var p=this.$subComponents[h],v=e[c];e[c]&&e[c].$__impex__origin&&(v=e[c].$__impex__origin,e[c].$__impex__origin=null,delete e[c].$__impex__origin),p[i]=v,p.$index=h++,r&&(p[r]=l?c>>0:c),p.init(),p.display(),t(p)}},this.createSubComp=function(){var e=this.$parentComp,t=this.$viewManager.createPlaceholder("");this.$viewManager.insertBefore(t,this.$placeholder);var n=this.$__view.clone(),r=e.createSubComponent(n,t);if(this.$subComponents.push(r),this.$trans){var i=this;r.onInit=function(){this.$transition||(this.$transition=i.$ts.get(i.$trans,this))},r.onDisplay=function(){this.$transition.enter()},r.leave=function(){this.suspend(!1),this.$__leaving=!1}}return r},this.doFilter=function(e){if(!this.$filters)return e;var t=this.$filters;if(Object.keys(t).length>0){e&&Util.isObject(e)&&(e=n(e));for(var r in t){for(var i=t[r][0],s=t[r][1],a=[],o=s.length;o--;){var l=s[o];l.varTree&&l.words&&(l=Renderer.evalExp(this.$parentComp,l)),a[o]=l}i.$value=e,e=i.to.apply(i,a)}return e}},this.build=function(e,t,n){var r=Util.isArray(e)?!0:!1,i=0;e=this.doFilter(e);for(var s in e)if(e.hasOwnProperty(s)&&!(r&&isNaN(s)||0===s.indexOf("$__"))){var a=this.createSubComp(),o=e[s];e[s]&&e[s].$__impex__origin&&(o=e[s].$__impex__origin,e[s].$__impex__origin=null,delete e[s].$__impex__origin),a[n]=o,a.$index=i++,t&&(a[t]=r?s>>0:s)}for(var l=this.$subComponents.length;l--;)this.$subComponents[l].init(),this.$subComponents[l].display()},this.parseExp=function(e){var t,n,r,i=this;return e.replace(this.$eachExp,function(e,s,a,o){t=s;var l=a.replace(/\s/gm,""),h=l.split(",");if(h.length>1?(n=h[0],r=h[1]):r=h[0],o){var c={},p=Scanner.parseFilters(lexer(o),c,i.$parent);i.$filters=c;for(var v in p)i.$parent.watch(v,function(e,t,n){i.$lastDS&&i.rebuild(i.$lastDS,-999,i.$expInfo.k,i.$expInfo.v)})}}),t?{ds:t,k:n,v:r}:void LOGGER.error("invalid each expression : "+e)}}e.directive("ignore",{$final:!0}).directive("on",{onInit:function(){for(var e=this.$params.length;e--;)this.$view.on(this.$params[e],this.$value)}}).directive("bind",{onInit:function(){(!this.$params||this.$params.length<1)&&LOGGER.warn("at least one attribute be binded")},observe:function(e){if(this.$params&&!(this.$params.length<1)){var t=null;if(this.$filter){var n=this.closest(this.$filter);n&&(t=n[this.$filter])}if(t){var r=t(e);if(!Util.isUndefined(r)&&!r)return}for(var i=this.$params.length;i--;){var s=this.$params[i];this.$view.attr(s,e)}}}}).directive("show",{onCreate:function(e){var t=this.$view.attr("transition");null!==t&&(this.$transition=e.get(t,this)),this.$lastRs=!1,this.exec(!1)},observe:function(e){this.$parent.$__state!==Component.state.suspend&&e!==this.$lastRs&&(this.$lastRs=e,this.$transition?e?this.$transition.enter():this.$transition.leave():this.exec(e))},enter:function(){this.exec(this.$lastRs)},leave:function(){this.exec(this.$lastRs)},exec:function(e){e?this.$view.show():this.$view.hide()}},["Transitions"]).directive("show-start",{$endTag:"show-end",onCreate:function(){this.__init(),this.display()},observe:function(e){if(this.$parent.$__state!==Component.state.suspend){var t=this.$view.__nodes;if(e)for(var n=t.length;n--;)t[n].style&&(t[n].style.display="");else for(var n=t.length;n--;)t[n].style&&(t[n].style.display="none")}}}).directive("if",{onCreate:function(e,t){this.viewManager=e,this.placeholder=e.createPlaceholder("-- directive [if] placeholder --");var n=this.$view.attr("transition");null!==n&&(this.$transition=t.get(n,this)),this.$lastRs=!1,this.exec(!1)},observe:function(e){this.$parent.$__state!==Component.state.suspend&&(e!==this.$lastRs||this.$view.el.parentNode)&&(this.$lastRs=e,this.$transition?e?this.$transition.enter():this.$transition.leave():this.exec(e))},enter:function(){this.exec(this.$lastRs)},leave:function(){this.exec(this.$lastRs)},exec:function(e){if(e){if(this.$view.el.parentNode)return;this.viewManager.replace(this.$view,this.placeholder)}else{if(!this.$view.el.parentNode)return;this.viewManager.replace(this.placeholder,this.$view)}}},["ViewManager","Transitions"]).directive("if-start",{$endTag:"if-end",onCreate:function(e){this.viewManager=e,this.placeholder=e.createPlaceholder("-- directive [if] placeholder --"),this.__init(),this.display()},observe:function(e){if(this.$parent.$__state!==Component.state.suspend)if(e){if(this.$view.__nodes[0].parentNode)return;this.viewManager.replace(this.$view,this.placeholder)}else{if(!this.$view.__nodes[0].parentNode)return;this.viewManager.replace(this.placeholder,this.$view)}}},["ViewManager"]).directive("cloak",{onCreate:function(){var e=this.$view.attr("class");if(!e)return void LOGGER.warn("can not find attribute[class] of element["+this.$view.name+"] which directive[cloak] on");e=e.replace("x-cloak","");var n=this;setTimeout(function(){t(n.$parent,n.$view.el,e);var r=n.$view.attr("class").replace("x-cloak","");n.$view.attr("class",r)},0)}}).directive("model",{onCreate:function(){var e=this.$view.el;switch(this.toNum=e.getAttribute("number"),this.debounce=e.getAttribute("debounce")>>0,e.nodeName.toLowerCase()){case"textarea":case"input":var t=this.$view.attr("type");switch(t){case"radio":this.$view.on("click","changeModel($event)");break;case"checkbox":this.$view.on("click","changeModelCheck($event)");break;default:var n=null===document.body.onpropertychange?"propertychange":"input";this.$view.on(n,"changeModel($event)")}break;case"select":var r=e.getAttribute("multiple");null!==r?this.$view.on("change","changeModelSelect($event)"):this.$view.on("change","changeModel($event)")}},changeModelSelect:function(e){for(var t=e.target||e.srcElement,n=(t.value,[]),r=t.options.length;r--;){var i=t.options[r];i.selected&&n.push(i.value)}this.$parent.data(this.$value,n)},changeModelCheck:function(e){var t=e.target||e.srcElement,n=t.value,r=this.$parent.data(this.$value);if(r instanceof Array||(r=[r]),t.checked)r.push(n);else{var i=r.indexOf(n);i>-1&&r.splice(i,1)}this.$parent.data(this.$value,r)},changeModel:function(e){if(this.debounce){this.debounceTimer&&(clearTimeout(this.debounceTimer),this.debounceTimer=null);var t=this;this.debounceTimer=setTimeout(function(){clearTimeout(t.debounceTimer),t.debounceTimer=null,t.setVal(e)},this.debounce)}else this.setVal(e)},setVal:function(e){var t=(e.target||e.srcElement).value;null!==this.toNum&&(t=parseFloat(t)),this.$parent.data(this.$value,t)}});var r=new n;r.$final=!0,r.$priority=999,e.directive("each",r,["ViewManager","Transitions"]);var i=new n;i.$endTag="each-end",i.$priority=999,e.directive("each-start",i,["ViewManager"])}(impex),impex.filter("json",{to:function(){return JSON.stringify(this.$value)}}).filter("filterBy",{to:function(e,t){var n=this.$value;if(!(n instanceof Array))return LOGGER.warn("can only filter array"),this.$value;var r=[];if(e instanceof Function)for(var i=n.length;i--;){var s=e.call(this,n[i]);s&&r.unshift(n[i])}else for(var i=n.length;i--;){var a=n[i];t?(!e||(a[t]+"").indexOf(e)>-1)&&r.unshift(a):(!e||a.indexOf&&a.indexOf(e)>-1)&&r.unshift(a)}return r}}).filter("limitBy",{to:function(e,t){return this.$value instanceof Array?e?this.$value.splice(t||0,e):this.$value:(LOGGER.warn("can only filter array"),this.$value)}}).filter("orderBy",{to:function(e,t){return e||t?this.$value instanceof Array?(this.$value.sort(function(t,n){var r=e?t[e]:t,i=e?n[e]:n;return"string"==typeof r?r.localeCompare(i):"number"==typeof r?r-i:(r+"").localeCompare(i)}),"desc"===t&&this.$value.reverse(),this.$value):(LOGGER.warn("can only filter array"),this.$value):this.$value}}),"object"==typeof module&&"object"==typeof module.exports?module.exports=impex:global.impex=impex}(window||this);