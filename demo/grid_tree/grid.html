<!DOCTYPE html>
<html >
    <head>
        <title>Impexui - grid</title>
		<META HTTP-EQUIV="Pragma" CONTENT="no-cache">
        <meta http-equiv="content-type" content="text/html;charset=utf-8">
		<link rel="stylesheet" type="text/css" href="../../themes/default/impexui.css"/>
		<link rel="stylesheet" type="text/css" href="../../themes/icon.css"/>
		<script type="text/javascript" src="F:/git/impex/build//impex.all.js"></script>
		<script type="text/javascript" src="../../build/impexui.all.js"></script>
		<script type="text/javascript" src="../../src/impex.component.js"></script>
		<script type="text/javascript" src="../../src/impex.filter.js"></script>
		<script type="text/javascript" src="../../src/impex.directive.js"></script>
		<script type="text/javascript" src="../../src/impex.util.js"></script>
		<script type="text/javascript" src="../../src/impexui.js"></script>
    </head>
    <body>
		<h3>基本表格</h3>
		<impex-datagrid id="baseGrid" title="基本的表格" titleIconCls="icon-grid" ds="studentData" cols="baseGrid.cols"></impex-datagrid>
		
		<h3>带排序的表格</h3>
		<impex-datagrid title="带排序的表格" titleIconCls="icon-grid" ds="studentData" cols="orderGrid.cols"></impex-datagrid>

		<h3>带工具栏的表格</h3>
		<impex-datagrid title="带工具栏的表格" toolbar="grid_toolbar" titleIconCls="icon-grid" ds="studentData" cols="toolbarGrid.cols"></impex-datagrid>
		<div id="grid_toolbar" x-ignore>
			<impex-linkbutton click="doAdd" iconcls="icon-add" text="新增"></impex-linkbutton>
			<impex-linkbutton click="doEdit" iconcls="icon-edit" text="编辑"></impex-linkbutton>
			<impex-linkbutton click="doDelete" iconcls="icon-remove" text="删除"></impex-linkbutton>
		</div>
		
		<h3>带复选框的表格</h3>
		<impex-datagrid id="checkboxGrid" title="带复选框的表格" toolbar="grid_toolbar" titleIconCls="icon-grid" ds="studentData" cols="checkboxGrid.cols"></impex-datagrid>
		
		<!--
		<h3>带分页的表格</h3>
		<impex-datagrid id="paginationGrid" title="带分页的表格" pagination="true" pager="pagerGrid.pager" toolbar="grid_toolbar" titleIconCls="icon-grid" ds="students" cols="pagerGrid.cols"></impex-datagrid>

		
		<h3>带行号的表格</h3>
		<impex-datagrid title="带行号的表格" linenumber="true" toolbar="grid_toolbar" titleIconCls="icon-grid" ds="studentData" cols="linenumberGrid.cols"></impex-datagrid>
		-->
		<script>
			var model = {
				data: {
					// 学生数据
					studentData:[
						{studentNo: "40231220", name: "孙膑", sex: "男", class: "计算机科学与技术2002-6班"},
						{studentNo: "40231221", name: "胡来", sex: "男", class: "计算机科学与技术2002-6班"},
						{studentNo: "40231222", name: "郝东芳", sex: "女", class: "计算机科学与技术2002-6班"},
						{studentNo: "40231223", name: "王伟", sex: "男", class: "计算机科学与技术2002-6班"}
					],
					baseGrid: {
						cols: [
							{code: "studentNo", title: "学号"},
							{code: "name", title: "姓名"},
							{code: "sex", title: "性别"},
							{code: "class", title: "班级"}
						]
					},
					orderGrid: {
						cols: [
							{code: "studentNo", title: "学号", order: true},
							{code: "name", title: "姓名"},
							{code: "sex", title: "性别", order: true},
							{code: "class", title: "班级"}
						]
					},
					toolbarGrid: {
						cols: [
							{code: "studentNo", title: "学号", order: true},
							{code: "name", title: "姓名"},
							{code: "sex", title: "性别", order: true},
							{code: "class", title: "班级"}
						]
					},
					checkboxGrid: {
						cols: [
							{code: "studentNo", width: "40", align: "center", checkbox: true},
							{code: "studentNo", title: "学号"},
							{code: "name", title: "姓名"},
							{code: "sex", title: "性别"},
							{code: "class", title: "班级"}
						]
					}
				},

				
				pagerGrid: {
					cols: [
						{code: "studentNo", width: "40", align: "center", checkbox: true},
						{code: "studentNo", title: "学号"},
						{code: "name", title: "姓名"},
						{code: "sex", title: "性别", order: true},
						{code: "class", title: "班级"}
					],
					pager: {
						current: 1,
						pageNos: [10, 20, 30, 50, 100],
						total: 143,
						pageSize: 10
					}
				},
				linenumberGrid: {
					cols: [
						{code: "studentNo", width: "40", align: "center", checkbox: true},
						{code: "studentNo", title: "学号"},
						{code: "name", title: "姓名"},
						{code: "sex", title: "性别"},
						{code: "class", title: "班级"}
					],
					pager: {
						pageNos: [10, 20, 30, 50, 100]
					}
				},
				students: [],
				onDisplay: function() {
					var students = [];
					var sex;
					for (var i = 0; i < 143; i++) {
						sex = (Math.random() * 10) > 5 ? "男" : "女";
						students.push({studentNo: 40231220 + i, name: "同学" + i, sex: sex, class: "计算机科学与技术2002-6班"});
					}
					this.students = students;
				},
				methods: {
					doAdd: function() {
						alert("新增");
					},
					doEdit: function() {
						alert("编辑");
					},
					doDelete: function() {
						var ckg = impex.cget("checkboxGrid");
						if (null == ckg) {
							alert("没有需要删除的项目");
							return;
						}
						var checkedIds = impex.cget("checkboxGrid").getChecked();
						if ("" === checkedIds) {
							alert("请选择要删除的行");
						}else{
							alert("删除成功");
						}
					}
				}
			};
			
			
			impex.component("impex-linkbutton", {
				template:  '<div class="impex-linkbutton {{=class}}" :click="clickHandler()">\
								<div class="icon {{=iconcls}}" x-if="_.isString(iconcls)"></div>\
								<div class="text" x-if="_.isString(text)">{{=text}}</div>\
							</div>',
				methods: {
					clickHandler: function() {
						var fn = getFn(this, this.data.click);
						if (null != fn) {
							fn(this);
						}else{
							this.emit("linkbutton.click");
						}
					}
				}
			});
			
			impex.component("impex-datagrid", {
				template: '<div id="{{=id}}" title="{{=title}}" class="impex-datagrid {{=class}}">\
								<div class="title" x-if="_.isString(title)"><i x-if="_.isString(titleiconcls)" class="icon {{=titleiconcls}}"></i> <div class="text">{{# title}}</div></div>\
								<div class="toolbar" x-if="_.isString(toolbar)">\
									{{# toolbarHtml}}\
								</div>\
								<table class="table" cellspacing="0" cellpadding="0" border="0">\
									<thead class="head">\
									<tr x-order="##orderId">\
										<th class="line-number" x-if="_.isString(linenumber) && \'true\' == linenumber"></th>\
										<th order="{{col.order ? col.code : \'\'}}" x-each="columns as col"  style="text-align:{{col.align}};width:{{col.width}}px;">\
											<span x-if="!col.checkbox">{{col.title}}</span>\
											<span x-if="col.checkbox" class="checkAll"><input :click="checkAll(this)" type="checkbox"/></span>\
										</th>\
									</tr>\
									</thead>\
									<tbody>\
										<tr x-if="needOrder" x-each="dataSource as d => orderBy:##orderId[\'key\']:##orderId[\'dir\'] .limitBy:pageSize:0">\
											<td class="line-number" x-if="_.isString(linenumber) && \'true\' == linenumber">{{$index + 1}}</td>\
											<td x-each="columns as col" style="text-align:{{col.align}};width:{{col.width}}px;">\
												<span x-if="!col.checkbox">{{d[col.code]}}</span>\
												<span x-if="col.checkbox" class="checkbox"><input :click="checkItem(this)" value="{{d[col.code]}}" type="checkbox"/></span>\
											</td>\
										</tr>\
										<tr x-if="!needOrder" x-each="dataSource as d => limitBy:pageSize:startSize">\
											<td class="line-number" x-if="_.isString(linenumber) && \'true\' == linenumber">{{$index + 1}}</td>\
											<td x-each="columns as col" style="text-align:{{col.align}};width:{{col.width}}px;">\
												<span x-if="!col.checkbox">{{d[col.code]}}</span>\
												<span x-if="col.checkbox" class="checkbox"><input :click="checkItem(this)" value="{{d[col.code]}}" type="checkbox"/></span>\
											</td>\
										</tr>\
									</tbody>\
								</table>\
								<div x-if="_.isString(pagination) && \'true\' == pagination"><impex-pager id="##pagerId"></impex-pager></div>\
							</div>',
				data: {
					dataSource: [],
					columns: [],
					needOrder: false,
					$checkIds: [],
					allChecked: false,
					pagerId: "",
					pageSize: 10,
					startSize: 0
				},
				onInit: function() {
					// 初始化数据源
					var dataSource = getData(this, this.data.ds);
					if (null != dataSource) {
						this.data.dataSource = dataSource;
					}

					if (_.isString(this.data.ds)) {
						var p = getParentModel(this, this.data.ds);
						if (null != p) {
							var that = this;
							p.watch(this.data.ds, function(type, newVal, oldVal, propChain) {
								that.data.dataSource = newVal;
							});
						}
					}

					// 初始化表头
					var columns = getData(this, this.data.cols);
					if (null != columns) this.data.columns = columns;
					for (var i = this.data.columns.length;i--;) {
						if (this.data.columns[i].order) {
							this.data.needOrder = true;
							break;
						}
					}
					
					// 初始化工具栏
					if (_.isString(this.data.toolbar)) {
						var barEl = document.getElementById(this.data.toolbar);
						if (null != barEl) {
							this.data.toolbarHtml = barEl.innerHTML;
							barEl.style.display = "none";
						}
					}					
				},
				onDisplay: function() {
					// 初始化分页
					if (_.isString(this.data.pagination) && "true" == this.data.pagination) {
						var pagerConfig = getData(this, this.data.pager);
						if (null != pagerConfig) {
							this.getPager().setConfig(pagerConfig);
						}
					}

					// 监听分页跳转
					this.on("pager.goto", function(pager, currentPage, pageSize) {
						this.pageSize = pageSize;
						this.startSize = (currentPage - 1) * this.pageSize;
					});
				},
				onBeforeCompile:function(str){
					this.data.pagerId = "pagerId_" + getId();
					return str.replace(/##orderId/g, "gridOrder_" + getId())
						      .replace(/##pagerId/g, this.data.pagerId);
				},
				methods:　{
					checkAll: function(checkbox) {
						var el = checkbox.view.el;
						var gridEl = document.getElementById(this.data.id);
						var checkboxs = gridEl.querySelectorAll(".checkbox input");
						if (el.checked) {
							var cs = [];
							var gridEl = document.getElementById(this.data.id);
							var checkboxs = gridEl.querySelectorAll(".checkbox input");
							for (var i = 0; i < checkboxs.length; i++) {
								cs.push(checkboxs[i].value);
							}
							this.data.$checkIds = cs;
						}else{
							this.data.$checkIds = [];
						}
						
						for (var i = checkboxs.length; i--;) {
							checkboxs[i].checked = el.checked;
						}
					},
					checkItem: function(checkbox) {
						var el = checkbox.view.el;
						if (el.checked) {
							this.data.$checkIds.push(el.value);
						}else{
							for (var i = 0; i < this.data.$checkIds.length; i++) {
								if (this.data.$checkIds[i] == el.value) {
									this.data.$checkIds.splice(i, 1);
									break;
								}
							}
						}
						var gridEl = document.getElementById(this.data.id);
						var all = gridEl.querySelectorAll(".checkAll input");
						all[0].checked = this.data.$checkIds.length == this.data.dataSource.length;
					}
				},
				getChecked: function() {
					return this.data.$checkIds.join(",");
				},
				getPager: function() {
					return impex.cget(this.data.pagerId);
				}
			});
			
			// 分页插件
			impex.component("impex-pager", {
				$template: 	'<div class="impex-pager {{=class}}">\
								<select class="pageNos" :change="changePageSize(this)">\
									<option x-each="pageNos as no" value="{{no}}">{{no}}</option>\
								</select>\
								<div class="separator"></div>\
								<div class="btn {{current == 1 ? \'btn-disabled\' : \'\'}}" :click="goto(1)"><i class="pagination-icon first-page"></i></div>\
								<div class="btn {{current == 1 ? \'btn-disabled\' : \'\'}}" :click="goto(current - 1)"><i class="pagination-icon prev-page"></i></div>\
								<div class="separator"></div>\
								<div class="pageNum-container">第 <input value="{{current}}" type="text" class="pageNum" size="2"/> 页 共 {{totalPage}} 页</div>\
								<div class="separator"></div>\
								<div class="btn {{current == totalPage ? \'btn-disabled\' : \'\'}}" :click="goto(current + 1)"><i class="pagination-icon next-page"></i></div>\
								<div class="btn {{current == totalPage ? \'btn-disabled\' : \'\'}}" :click="goto(totalPage)"><i class="pagination-icon last-page"></i></div>\
								<div class="separator"></div>\
								<div class="btn" :click="refresh()"><i class="pagination-icon refresh"></i></div>\
								<div class="pagination-info">显示 {{(current - 1) * pageSize + 1}} 到 {{(pageSize * current) > total ? total : (pageSize * current)}} 条 共 {{total}} 条</div>\
							</div>',
				current: 1,
				pageSize: 10,
				total: 0,
				totalPage: 0,
				pageNos: [10, 20, 30, 40, 50],
				onInit: function() {
					
				},
				setConfig: function(config) {
					this.current = config.current || this.current;
					this.pageSize = config.pageSize || this.pageSize;
					this.total = config.total || this.total;
					this.pageNos = config.pageNos || this.pageNos;
					
					this.totalPage = Math.ceil(this.total/this.pageSize);
				},
				goto: function(current) {
					if (current == this.current || current <= 0 || current > this.totalPage) return;
					this.current = current;
					this.emit("pager.goto", current, this.pageSize);
				},
				refresh: function() {
					this.emit("pager.goto", this.current, this.pageSize);
				},
				changePageSize: function(select) {
					this.current = 1;
					this.pageSize = select.$view.el.value;
					this.emit("pager.goto", this.current, this.pageSize);
				}
			});
			
			var page = impex.render(document.body, model);
		</script>
    </body>
</html>